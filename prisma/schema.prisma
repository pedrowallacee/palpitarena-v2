generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
// 1. USUÁRIOS E PERFIL
// =========================================================

model User {
  id       String  @id @default(cuid())
  name     String
  email    String  @unique
  password String
  image    String?
  role     Role    @default(USER)

  // --- NOVOS CAMPOS PARA RANKING GERAL ---
  globalPoints Int @default(0)
  titles       Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownedChampionships Championship[]            @relation("ChampionshipOwner")
  participations     ChampionshipParticipant[]
  predictions        Prediction[]
  notifications      Notification[]
  requests           ChampionshipRequest[]
}

// =========================================================
// 2. CAMPEONATOS (O Torneio)
// =========================================================

model Championship {
  id   String @id @default(cuid())
  name String
  slug String @unique

  code        String  @unique
  leagueType  String
  description String?
  logo        String?
  banner      String?

  apiLeagueId Int?

  format          ChampionshipFormat @default(POINTS)
  status          ChampionshipStatus @default(REGISTRATION)
  maxParticipants Int                @default(20)
  hasGroupStage   Boolean            @default(true)
  hasKnockout     Boolean            @default(true)
  adminPhone      String?

  // --- NOVOS CAMPOS PARA REGRAS E AUTOMAÇÃO ---
  totalRounds     Int? // Ex: 38 rodadas, ou 6 rodadas
  matchesPerRound Int? // Quantos jogos por rodada
  currentStage    String @default("GROUPS") // GRUPOS, R16, QUARTASS, SEMIS, FINAL
  rulesConfig     Json? // Guarda regras complexas (ex: { "classificam": 2, "ida_e_volta": true })

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerId String
  owner   User   @relation("ChampionshipOwner", fields: [ownerId], references: [id])

  rounds       Round[]
  participants ChampionshipParticipant[]
}

// =========================================================
// 3. PARTICIPANTES
// =========================================================

model ChampionshipParticipant {
  id       String   @id @default(cuid())
  joinedAt DateTime @default(now())

  teamName  String
  teamLogo  String?
  teamApiId Int?

  group String? // Ex: "A", "B", "C"

  points        Int @default(0)
  matchesPlayed Int @default(0)
  wins          Int @default(0)
  draws         Int @default(0)
  losses        Int @default(0)

  predictionPoints Int @default(0)
  pointsConceded   Int @default(0)

  // Opcional para permitir "Times Abandonados" ou "CPU"
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  championshipId String
  championship   Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)

  homeDuels Duel[] @relation("HomeParticipant")
  awayDuels Duel[] @relation("AwayParticipant")
  wonDuels  Duel[] @relation("DuelWinner")
}

// =========================================================
// 4. RODADAS
// =========================================================

model Round {
  id       String      @id @default(cuid())
  name     String
  type     RoundType   @default(GROUP_STAGE)
  status   RoundStatus @default(SCHEDULED)
  deadline DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  championshipId String
  championship   Championship @relation(fields: [championshipId], references: [id], onDelete: Cascade)

  matches     Match[]
  duels       Duel[]
  predictions Prediction[]
}

// =========================================================
// 5. JOGOS REAIS
// =========================================================

model Match {
  id    String @id @default(cuid())
  apiId Int?   @unique // ID externo da API-Football

  homeTeam String
  awayTeam String
  homeLogo String?
  awayLogo String?

  date     DateTime
  location String?
  status   MatchStatus @default(SCHEDULED)

  homeScore Int?
  awayScore Int?

  details Json? // Gols, cartões, etc.

  roundId String
  round   Round  @relation(fields: [roundId], references: [id], onDelete: Cascade)

  predictions Prediction[]
}

// =========================================================
// 6. DUELOS (PvP - Jogador vs Jogador)
// =========================================================

model Duel {
  id String @id @default(cuid())

  homeParticipantId String
  homeParticipant   ChampionshipParticipant @relation("HomeParticipant", fields: [homeParticipantId], references: [id])

  awayParticipantId String
  awayParticipant   ChampionshipParticipant @relation("AwayParticipant", fields: [awayParticipantId], references: [id])

  homeScore Int @default(0) // Pontos que o Jogador A fez nos palpites
  awayScore Int @default(0) // Pontos que o Jogador B fez nos palpites

  winnerId String?
  winner   ChampionshipParticipant? @relation("DuelWinner", fields: [winnerId], references: [id])

  isWO   Boolean    @default(false)
  status DuelStatus @default(SCHEDULED)

  roundId String
  round   Round  @relation(fields: [roundId], references: [id], onDelete: Cascade)
}

// =========================================================
// 7. PALPITES
// =========================================================

model Prediction {
  id String @id @default(cuid())

  homeScore Int
  awayScore Int

  pointsEarned Int     @default(0)
  exactScore   Boolean @default(false)
  isProcessed  Boolean @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  matchId String
  match   Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)

  roundId String?
  round   Round?  @relation(fields: [roundId], references: [id])

  @@unique([userId, matchId])
}

// =========================================================
// 8. NOTIFICAÇÕES E SOLICITAÇÕES
// =========================================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ChampionshipRequest {
  id          String        @id @default(cuid())
  name        String
  description String?
  leagueType  String
  whatsapp    String
  status      RequestStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =========================================================
// ENUMS
// =========================================================

enum Role {
  USER
  ADMIN
}

enum ChampionshipFormat {
  POINTS
  KNOCKOUT
  GROUPS
}

enum ChampionshipStatus {
  REGISTRATION
  ACTIVE
  GROUP_STAGE
  KNOCKOUT
  FINISHED
}

enum RoundType {
  GROUP_STAGE
  ROUND_OF_16
  QUARTER_FINAL
  SEMI_FINAL
  FINAL
  THIRD_PLACE
}

enum RoundStatus {
  SCHEDULED
  OPEN
  CLOSED
  FINISHED
}

enum MatchStatus {
  SCHEDULED
  LIVE
  FINISHED
  POSTPONED
}

enum DuelStatus {
  SCHEDULED
  FINISHED
  CANCELED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}
